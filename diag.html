<!doctype html>
<meta charset="utf-8"/>
<title>GameCre8 Diagnostics</title>
<style>
  :root{--bg:#0b0f18;--card:#111827;--fg:#e8e8f0;--muted:#93a1b1;--ok:#18c964;--bad:#ff6b6b}
  html,body{margin:0;background:#000;color:var(--fg);font-family:ui-sans-serif,system-ui}
  .wrap{max-width:920px;margin:24px auto;padding:16px}
  h1{margin:0 0 12px 0}
  .card{background:var(--card);border:1px solid #1c2333;border-radius:12px;padding:16px;margin:12px 0}
  .btn{padding:10px 14px;border:0;border-radius:10px;background:#4b6bff;color:#fff;font-weight:800;cursor:pointer}
  .muted{color:var(--muted)}
  .row{display:flex;align-items:center;gap:8px;line-height:1.6}
  .ok{color:var(--ok);font-weight:700}
  .bad{color:var(--bad);font-weight:700}
  code{background:#0e1525;border:1px solid #1c2333;border-radius:6px;padding:2px 6px}
  a{color:#9dc1ff}
  ul{margin:6px 0 0 18px}
</style>
<div class="wrap">
  <h1>ðŸ§ª GameCre8 Diagnostics</h1>
  <div class="card">
    <div class="row"><button class="btn" id="quick">Run Quick Test</button><span class="muted">(~10s)</span></div>
    <div class="row" style="margin-top:6px"><button class="btn" id="full">Run Full Test</button><span class="muted">(~20â€“30s)</span></div>
    <div class="muted" style="margin-top:8px">Checks: base, <code>/api/health</code>, <code>/api/generate</code>, <code>/api/mutate</code>, <code>/api/smoke</code>, and core asset URLs.</div>
  </div>
  <div class="card" id="out"><em class="muted">Results will appear hereâ€¦</em></div>
  <div class="card">
    <strong>Instant fixes:</strong>
    <ul>
      <li><strong>ASSETS_BASE wrong/missing</strong> â†’ Vercel â†’ Settings â†’ Env â†’ set <code>ASSETS_BASE</code> to your Supabase public bucket base (no trailing slash).</li>
      <li><strong>404 asset</strong> â†’ In Supabase upload at exact paths (case sensitive): <code>Backgrounds/black.png</code>, <code>Spritesheet/playerShip1_blue.png</code>, <code>Enemies/enemyBlue3.png</code>, <code>Meteors/meteorBrown_big1.png</code>, <code>Lasers/laserBlue06.png</code>.</li>
      <li><strong>Custom domain stale</strong> â†’ test the <code>.vercel.app</code> URL; domain will catch up.</li>
    </ul>
  </div>
</div>
<script>
const out = document.getElementById('out');
const log = (html) => out.innerHTML += html + "<br/>";

async function head(url){
  try{ const r = await fetch(url, { method:"HEAD", cache:"no-store" });
       return { ok:r.ok, status:r.status, url }; }
  catch(e){ return { ok:false, status:0, url, error:e.message }; }
}
async function get(url){
  try{ const r = await fetch(url, { cache:"no-store" });
       const t = await r.text(); let json=null;
       try{ json = JSON.parse(t); }catch{}
       return { ok:r.ok, status:r.status, url, body:json||t };
  } catch(e){ return { ok:false, status:0, url, error:e.message }; }
}
async function post(url, body){
  try{ const r = await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body||{}) });
       const t = await r.text(); let json=null;
       try{ json = JSON.parse(t); }catch{}
       return { ok:r.ok, status:r.status, url, body:json||t };
  } catch(e){ return { ok:false, status:0, url, error:e.message }; }
}
function line(ok, label, extra=""){ const cls = ok ? "ok" : "bad"; return `<div class="row"><span class="${cls}">${ok?"PASS":"FAIL"}</span> â€” ${label} ${extra}</div>`; }

async function run(full=false){
  out.innerHTML = "";
  const base = location.origin;
  log(`<div class="row">Base: <code>${base}</code></div>`);

  const h = await get(`${base}/api/health`);
  log(line(h.ok, `/api/health â†’ HTTP ${h.status}`, h.ok?``:`<code>${h.body||h.error||""}</code>`));

  const g = await post(`${base}/api/generate`, { slug: "galaxy-blaster" });
  const gOk = g.ok && g.body && g.body.sprites && g.body.gameplay;
  log(line(gOk, `/api/generate â†’ HTTP ${g.status}`, gOk?``:`<code>${(g.body && JSON.stringify(g.body)).slice(0,140)}</code>`));

  const m = await post(`${base}/api/mutate`, { config: g.body, upgrade: "triple_shot" });
  const mOk = m.ok && m.body && m.body.gameplay;
  log(line(mOk, `/api/mutate â†’ HTTP ${m.status}`, mOk?``:`<code>${(m.body && JSON.stringify(m.body)).slice(0,140)}</code>`));

  const s = await get(`${base}/api/smoke`);
  const sOk = s.ok && s.body && (s.body.ok === true || Array.isArray(s.body.results));
  log(line(sOk, `/api/smoke â†’ HTTP ${s.status}`, sOk?``:`<code>${(s.body && JSON.stringify(s.body)).slice(0,140)}</code>`));

  let assetUrls = [];
  if (sOk && Array.isArray(s.body.results)) assetUrls = s.body.results.map(r => r.url);
  else if (gOk) assetUrls = Object.values(g.body.sprites || {});
  if (assetUrls.length){
    if (full) log(`<div class="row muted">Checking ${assetUrls.length} asset URLsâ€¦</div>`);
    const checks = full ? assetUrls : assetUrls.slice(0,5);
    for (const u of checks) {
      const r = await head(u);
      log(line(r.ok, `ASSET ${r.ok ? "200" : r.status}`, ` â€” <a target="_blank" href="${u}">${u.split('/').slice(-3).join('/')}</a>`));
    }
  } else {
    log(line(false, "No asset URLs found"));
  }
  const green = gOk && mOk && sOk; // health is optional
  log(`<div class="row" style="margin-top:8px"><strong class="${green?"ok":"bad"}">${green?"ALL CRITICAL CHECKS PASS":"ONE OR MORE CHECKS FAILED"}</strong></div>`);
}
document.getElementById('quick').onclick = ()=>run(false);
document.getElementById('full').onclick  = ()=>run(true);
</script>
